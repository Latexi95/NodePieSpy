<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/api.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: lib/api.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>var express = require('express')
	, cors = require('cors');

/**
 * WebAPI creates a new HTTP server that handles API requests.
 * @constructor
 * @param {Object} analysers - Named analysers to serve
 * @param {Object} config - Configuration object
 */
function WebAPI(analysers, config) {
	this.analysers = analysers;
	var app = this.api = express();
	this.config = config;

	app.configure(function () {
		app.use(express.compress());
	});
}

/**
 * Check that channel parameter is correct and populate request object with channel and analyser.
 * @private
 */
WebAPI.prototype.checkChannel = function (req, res, next) {
	if (!(req.params.channel in this.analysers)) {
		res.status(404).end('Channel does not exist.');
		return;
	}
	req.channel = req.params.channel;
	req.analyser = this.analysers[req.channel];

	next();
};

/**
 * Register an Channel API.
 * @private
 * @param {String} name - Name of the api
 * @param {Function} method - Function to call
 * @param {String[]} [params] - Optional parameters
 */
WebAPI.prototype.registerChannelAPI = function (name, method, params) {
	if (!params) {
		this.api.get('/' + name + '/:channel.json', cors(),
			this.checkChannel.bind(this), method.bind(this));
	} else {
		this.api.get('/' + name + '/:channel/:' + params.join('/:') + '.json', cors(),
			this.checkChannel.bind(this), method.bind(this));
	}
};

/**
 * Serves graph for a channel.
 * @private
 */
WebAPI.prototype.getChannel = function (req, res) {
	res.send({ nodes: req.analyser.nodes, edges: req.analyser.edges });
};

/**
 * Serves a list of available channels.
 * @private
 */
WebAPI.prototype.getChannels = function (req, res) {
	res.send(Object.keys(this.analysers));
};

/**
 * Serves graph for a channel as an adjacency list.
 * @private
 */
WebAPI.prototype.getList = function (req, res) {
	res.send(req.analyser.getList());
};

/**
 * Serves a BFS tree for a channel.
 * @private
 */
WebAPI.prototype.getBFS = function (req, res) {
	if (req.analyser.hasNode(req.params.start)) {
		res.send(req.analyser.bfs(req.params.start));
	} else {
		res.status(400).end('Invalid start node.');
	}
};

/**
 * Start listening for requests.
 */
WebAPI.prototype.start = function () {
	this.api.get('/channel', cors(), this.getChannels.bind(this));

	this.registerChannelAPI('channel', this.getChannel);
	this.registerChannelAPI('list', this.getList);
	this.registerChannelAPI('bfs', this.getBFS, ['start']);

	this.api.listen(this.config.port);
	return this;
};

module.exports = WebAPI;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-AnalyserTest.html">AnalyserTest</a></li><li><a href="module-bfs.html">bfs</a></li><li><a href="module-parser.html">parser</a></li><li><a href="module-toList.html">toList</a></li></ul><h3>Classes</h3><ul><li><a href="AdjacencyInference.html">AdjacencyInference</a></li><li><a href="Analyser.html">Analyser</a></li><li><a href="Edge.html">Edge</a></li><li><a href="Node.html">Node</a></li><li><a href="WebAPI.html">WebAPI</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0</a> on Mon Dec 23 2013 19:33:11 GMT+0200 (EET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
